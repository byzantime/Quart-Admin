{% extends "admin/base.html" %}

{% block title %}{{ view.name }} - {{ config.site_name }} Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-table me-2"></i>
        {{ view.name }}
    </h1>
    
    <div class="btn-toolbar mb-2 mb-md-0">
        {% if view.can_create %}
        <a href="{{ view.get_create_url() }}" class="btn btn-success">
            <i class="bi bi-plus-lg me-1"></i>
            Create New
        </a>
        {% endif %}
        
        {% if view.can_export %}
        <a href="{{ view.get_export_url() }}" class="btn btn-outline-primary ms-2">
            <i class="bi bi-download me-1"></i>
            Export
        </a>
        {% endif %}
    </div>
</div>

<!-- Search and Filters -->
{% if config.enable_search and view.get_searchable_columns() %}
<div class="row mb-3">
    <div class="col-md-6">
        <form method="GET" action="{{ view.get_list_url() }}">
            <div class="input-group">
                <input type="text" 
                       class="form-control" 
                       name="search" 
                       value="{{ search or '' }}" 
                       placeholder="Search {{ view.name }}...">
                <button class="btn btn-outline-secondary" type="submit">
                    <i class="bi bi-search"></i>
                </button>
                {% if search %}
                <a href="{{ view.get_list_url() }}" class="btn btn-outline-secondary">
                    <i class="bi bi-x"></i>
                </a>
                {% endif %}
            </div>
        </form>
    </div>
</div>
{% endif %}

<!-- Results Count -->
<div class="row mb-2">
    <div class="col-12">
        <small class="text-muted">
            {% if total_count %}
            Showing {{ items|length }} of {{ total_count }} {{ view.name.lower() }}
            {% if search %}
            for "{{ search }}"
            {% endif %}
            {% else %}
            No {{ view.name.lower() }} found
            {% endif %}
        </small>
    </div>
</div>

<!-- Data Table -->
{% if items %}
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                {% if config.enable_batch_actions %}
                <th scope="col" style="width: 40px;">
                    <input type="checkbox" class="form-check-input" id="selectAll">
                </th>
                {% endif %}
                
                {% for column in columns %}
                <th scope="col">
                    {{ column_labels.get(column, column.replace('_', ' ').title()) }}
                    {% if column in view.get_searchable_columns() %}
                    <i class="bi bi-search text-muted" title="Searchable"></i>
                    {% endif %}
                </th>
                {% endfor %}
                
                <th scope="col" style="width: 150px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            <tr>
                {% if config.enable_batch_actions %}
                <td>
                    <input type="checkbox" class="form-check-input row-select" value="{{ item.id }}">
                </td>
                {% endif %}
                
                {% for column in columns %}
                <td>
                    {% if column == 'id' or column.endswith('_id') %}
                    <code>{{ view.format_column_value(item, column) }}</code>
                    {% else %}
                    {{ view.format_column_value(item, column) }}
                    {% endif %}
                </td>
                {% endfor %}
                
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        {% if view.can_view_details %}
                        <a href="{{ view.get_details_url(item.id) }}" 
                           class="btn btn-outline-info" 
                           title="View Details">
                            <i class="bi bi-eye"></i>
                        </a>
                        {% endif %}
                        
                        {% if view.can_edit %}
                        <a href="{{ view.get_edit_url(item.id) }}" 
                           class="btn btn-outline-primary" 
                           title="Edit">
                            <i class="bi bi-pencil"></i>
                        </a>
                        {% endif %}
                        
                        {% if view.can_delete %}
                        <form method="POST" 
                              action="{{ view.get_delete_url(item.id) }}" 
                              style="display: inline;"
                              onsubmit="return confirm('Are you sure you want to delete this {{ view.name.lower() }}?')">
                            <button type="submit" 
                                    class="btn btn-outline-danger" 
                                    title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
{% if total_count > per_page %}
<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
        {% set total_pages = (total_count + per_page - 1) // per_page %}
        
        {% if page > 1 %}
        <li class="page-item">
            <a class="page-link" href="{{ view.get_list_url() }}?page={{ page - 1 }}{% if search %}&search={{ search }}{% endif %}">
                <i class="bi bi-chevron-left"></i>
            </a>
        </li>
        {% endif %}
        
        {% for p in range(1, total_pages + 1) %}
        {% if p == page %}
        <li class="page-item active">
            <span class="page-link">{{ p }}</span>
        </li>
        {% elif p <= 3 or p > total_pages - 3 or (p >= page - 2 and p <= page + 2) %}
        <li class="page-item">
            <a class="page-link" href="{{ view.get_list_url() }}?page={{ p }}{% if search %}&search={{ search }}{% endif %}">{{ p }}</a>
        </li>
        {% elif p == 4 or p == total_pages - 3 %}
        <li class="page-item disabled">
            <span class="page-link">...</span>
        </li>
        {% endif %}
        {% endfor %}
        
        {% if page < total_pages %}
        <li class="page-item">
            <a class="page-link" href="{{ view.get_list_url() }}?page={{ page + 1 }}{% if search %}&search={{ search }}{% endif %}">
                <i class="bi bi-chevron-right"></i>
            </a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

{% else %}
<!-- Empty State -->
<div class="text-center py-5">
    <i class="bi bi-inbox display-1 text-muted"></i>
    <h3 class="mt-3 text-muted">No {{ view.name.lower() }} found</h3>
    <p class="text-muted">
        {% if search %}
        No results match your search criteria.
        <br>
        <a href="{{ view.get_list_url() }}" class="btn btn-link">Clear search</a>
        {% else %}
        Get started by creating your first {{ view.name.lower() }}.
        {% endif %}
    </p>
    {% if view.can_create and not search %}
    <a href="{{ view.get_create_url() }}" class="btn btn-primary">
        <i class="bi bi-plus-lg me-1"></i>
        Create {{ view.name }}
    </a>
    {% endif %}
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Select all functionality
document.getElementById('selectAll')?.addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.row-select');
    checkboxes.forEach(checkbox => checkbox.checked = this.checked);
});

// Individual checkbox handling
document.querySelectorAll('.row-select').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const selectAll = document.getElementById('selectAll');
        const allChecked = Array.from(document.querySelectorAll('.row-select')).every(cb => cb.checked);
        const noneChecked = Array.from(document.querySelectorAll('.row-select')).every(cb => !cb.checked);
        
        if (selectAll) {
            selectAll.checked = allChecked;
            selectAll.indeterminate = !allChecked && !noneChecked;
        }
    });
});
</script>
{% endblock %}